<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>Lua程序设计</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="dirtysalt" />
<link rel="shortcut icon" href="https://dirtysalt.github.io/css/favicon.ico" />
<link rel="stylesheet" type="text/css" href="./css/site.css" />
</head>
<body>
<div id="content">
<h1 class="title">Lua程序设计</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline6">1. 第一部分(C1~C10)</a>
<ul>
<li><a href="#orgheadline1">1.1. 类型，表达式，语句</a></li>
<li><a href="#orgheadline2">1.2. 函数/深入函数/迭代器与泛型for</a></li>
<li><a href="#orgheadline3">1.3. 编译执行与错误</a></li>
<li><a href="#orgheadline4">1.4. 协同程序(coroutine)</a></li>
<li><a href="#orgheadline5">1.5. 完整的示例</a></li>
</ul>
</li>
<li><a href="#orgheadline7">2. 第二部分(C11~C17)</a></li>
<li><a href="#orgheadline8">3. 第三部分(C18~C23)</a></li>
<li><a href="#orgheadline9">4. 第四部分(C24~C31)</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6"><span class="section-number-2">1</span> 第一部分(C1~C10)</h2>
<div class="outline-text-2" id="text-1">
<p>
这个部分介绍基本语法以及简单地介绍Lua环境。
</p>
</div>

<div id="outline-container-orgheadline1" class="outline-3">
<h3 id="orgheadline1"><span class="section-number-3">1.1</span> 类型，表达式，语句</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Lua有8种基础类型，通过函数 `type` 来了解具体类型
</p>
<ol class="org-ol">
<li>nil(无效值)</li>
<li>boolean(true/false)</li>
<li>number(整数或者是双精度浮点)</li>
<li>string</li>
<li>userdata(自定义类型)</li>
<li>function</li>
<li>thread(线程)</li>
<li>table</li>
</ol>

<p>
如果要写入长字符串的话，可以使用下面这种格式.
</p>
<div class="org-src-container">

<pre class="src src-Lua">s = [[this is a very long string.
could be multiple lines]]
</pre>
</div>
<p>
获得字符串长度(table的大小)，可以使用 `#var` 得到。
</p>

<p>
table既可以认为是一个dict, 也可以认为是array. 非常灵活的数据结构。
</p>
<ul class="org-ul">
<li>`a['x'] = 10` 或者是 `a.x = 10`</li>
<li>lua数组通常以1作为索引的起始值</li>
<li>lua将nil作为界定数组结尾的标识（这点在lua环境中很常见）</li>
</ul>
<div class="org-src-container">

<pre class="src src-Lua">a = {[1] = 10, [2] = 20, [10] = 10}
for i, v in ipairs(a) do
   print(i, v)
end
print(#a)
</pre>
</div>

<p>
table constructor(table构造式）很有趣，同时兼容key/value和array的构造
</p>
<ul class="org-ul">
<li>`days = {'Sun', 'Mon', 'Tue'}` 数组构造，下标从1开始</li>
<li>`point = {x = 10, y = 20}` 字典构造</li>
<li>上面两者也可以混合在一起</li>
<li>同时支持表达式做key `days = {["*"] = mul}` 或者是 `days = {[ 0 ] = 20}`</li>
<li>虽然上面的写法支持下标为0，但是最好不要这么使用。</li>
</ul>

<p>
多变量赋值时，如果没有匹配上的话，那么剩余的变量自动匹配到 nil. 多余的自动忽略。
或者是如果直接声明 `local a` 的话，那么 `a` 的默认值也是 nil. 整个lua环境对 nil 有非常特殊的处理。
</p>

<p>
块(block)(通常是do-end部分）是规定了local(局部)变量的作用范围。常见控制结构有
</p>
<ul class="org-ul">
<li>if then(else/elseif) end</li>
<li>while do &#x2026; end</li>
<li>repeat &#x2026; until</li>
<li>for var=exp1, exp2, exp3 do &#x2026; end(数字型for, numeric for)
<ul class="org-ul">
<li>如果exp2很大的话可以用 `math.huge` 来表示无线循环</li>
<li>`var` 作用域仅限于这个block，不要对 `var` 做任何赋值</li>
</ul></li>
<li>for var1, var2 in func do &#x2026; end(泛型for, generic for)</li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-3">
<h3 id="orgheadline2"><span class="section-number-3">1.2</span> 函数/深入函数/迭代器与泛型for</h3>
<div class="outline-text-3" id="text-1-2">
<p>
lua的函数定义和scheme很像，默认地都是匿名函数，至于 `function a()` 不过是 `a = function()` 这种语法糖形式。
</p>

<p>
函数调用中比较有意思的是，如果只有一个参数并且该参数是字符串或者是table构造式的话，可以省略 `()`. 这样的话写出来就非常漂亮比如
</p>
<div class="org-src-container">

<pre class="src src-Lua">print 'hello, world'
a, b = table.unpack{10, 20}
print(a, b)
</pre>
</div>
<p>
这里 `unpack` 是将一个数组拆解开来。
</p>

<p>
变长参数在C语言里面需要花费很大的力气才能解开，但是lua里面使用却很容易。
</p>
<div class="org-src-container">

<pre class="src src-lua"><span class="org-keyword">function</span> <span class="org-function-name">test_vargs</span>(a, b, ...)
   <span class="org-builtin">print</span>(<span class="org-string">'a = '</span> .. a .. <span class="org-string">" , b = "</span> .. b)
   <span class="org-keyword">for</span> <span class="org-variable-name">i</span> = 1, <span class="org-builtin">select</span>(<span class="org-string">'#'</span>, ...) <span class="org-keyword">do</span>
      <span class="org-builtin">print</span>(<span class="org-string">'varg #'</span> .. i .. <span class="org-string">" = "</span> .. <span class="org-builtin">select</span>(i, ...))
   <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
test_vargs(10,20, <span class="org-builtin">table</span>.<span class="org-builtin">unpack</span>{30, 40 , 50})
</pre>
</div>

<p>
Lua本身并不支持具名实参 `named arguments`. 但是有个workaround, 就是传入table/字典
</p>
<div class="org-src-container">

<pre class="src src-Lua">function get_named_args(args)
   keys = {"height", "width", "depth"}
   for i, k in ipairs(keys) do
      local arg = args[k]
      print(k .. ' = ' .. arg)
   end
end
get_named_args({height = 100, width = 200, depth = 50})
</pre>
</div>
<p>
虽然结果是想要的，但是好像不是那么地优雅。
</p>

<p>
`深入函数` 这节里面展示了闭包的使用
</p>

<p>
泛型for `for v1, v2, &#x2026;  in &lt;explist&gt; do &#x2026; end ` 的执行如下：
</p>


<div class="figure">
<p><img src="./images/lua-generic-for-execution.png" alt="lua-generic-for-execution.png" />
</p>
</div>

<p>
所以实际上迭代可以通过 `_var`(控制变量) 控制，可以通过 `_s`(状态). 使用 `_var`得到的迭代器是无状态的迭代器，而使用 `_s`得到的迭代器是有状态的。尽可能使用无状态的迭代器。
</p>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">1.3</span> 编译执行与错误</h3>
<div class="outline-text-3" id="text-1-3">
<p>
`loadstring`可以载入外部代码，`loadfile`可以载入代码文件。两者返回的都是一个function对象。只有执行这个function对象代码才会变真正执行，在执行的时候也是可以传入参数的。
</p>

<p>
`package.loadlib`可以载入C代码（动态加载）。这个函数不是标准ANSI C的实现，但是因为这个函数太重要的，所以lua在每个平台上都有特定实现。
</p>

<p>
`errro("error message")` 汇报错误；`assert` 做断言；`pcall`可以在保护模式(protected mode下面)调用函数，分别返回值和错误；`debug.traceback`可以打印出错堆栈。
</p>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">1.4</span> 协同程序(coroutine)</h3>
<div class="outline-text-3" id="text-1-4">
<p>
coroutine的几个相关操作
</p>
<ul class="org-ul">
<li>`co = coroutine.create(func)`</li>
<li>`coroutine.resume(co, &#x2026;)` 让co继续执行
<ul class="org-ul">
<li>初始阶段传入参数，被传入 `func`</li>
<li>返回值(ok, `yield` 传入的参数)</li>
</ul></li>
<li>`coroutine.yield` 传入的参数被 `resume` 返回，只能在co里面调用</li>
<li>`coroutine.status` 查询co的状态
<ul class="org-ul">
<li>suspended 挂起</li>
<li>running 运行</li>
<li>dead 死亡</li>
<li>normal 正常</li>
</ul></li>
</ul>

<p>
书里面producer/consumer的例子改写成为coroutine方式如下
</p>
<div class="org-src-container">

<pre class="src src-lua"><span class="org-comment-delimiter">-- </span><span class="org-comment">function producer()</span>
<span class="org-comment-delimiter">--    </span><span class="org-comment">while true do</span>
<span class="org-comment-delimiter">--       </span><span class="org-comment">local x = io.read()</span>
<span class="org-comment-delimiter">--       </span><span class="org-comment">send(x)</span>
<span class="org-comment-delimiter">--    </span><span class="org-comment">end</span>
<span class="org-comment-delimiter">-- </span><span class="org-comment">end</span>

producer = <span class="org-builtin">coroutine</span>.<span class="org-builtin">create</span>(
   <span class="org-keyword">function</span>()
      <span class="org-keyword">while</span> <span class="org-constant">true</span> <span class="org-keyword">do</span>
         <span class="org-keyword">local</span> <span class="org-variable-name">x</span> = <span class="org-builtin">io</span>.<span class="org-builtin">read</span>()
         send(x)
      <span class="org-keyword">end</span>
   <span class="org-keyword">end</span>
)

<span class="org-keyword">function</span> <span class="org-function-name">consumer</span>()
   <span class="org-keyword">while</span> <span class="org-constant">true</span> <span class="org-keyword">do</span>
      <span class="org-keyword">local</span> <span class="org-variable-name">x</span> = receive()
      <span class="org-builtin">io</span>.<span class="org-builtin">write</span>(x, <span class="org-string">"\n"</span>)
   <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">receive</span>()
   <span class="org-keyword">local</span> <span class="org-variable-name">status</span>, <span class="org-variable-name">value</span> = <span class="org-builtin">coroutine</span>.<span class="org-builtin">resume</span>(producer)
   <span class="org-keyword">return</span> value
<span class="org-keyword">end</span>

<span class="org-keyword">function</span> <span class="org-function-name">send</span>(x)
   <span class="org-builtin">coroutine</span>.<span class="org-builtin">yield</span>(x)
<span class="org-keyword">end</span>

consumer()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline5" class="outline-3">
<h3 id="orgheadline5"><span class="section-number-3">1.5</span> 完整的示例</h3>
</div>
</div>

<div id="outline-container-orgheadline7" class="outline-2">
<h2 id="orgheadline7"><span class="section-number-2">2</span> 第二部分(C11~C17)</h2>
<div class="outline-text-2" id="text-2">
<p>
深入介绍Lua环境
</p>

<p>
TODO:
</p>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-2">
<h2 id="orgheadline8"><span class="section-number-2">3</span> 第三部分(C18~C23)</h2>
<div class="outline-text-2" id="text-3">
<p>
Lua各种库的使用方法
</p>

<p>
TODO:
</p>
</div>
</div>

<div id="outline-container-orgheadline9" class="outline-2">
<h2 id="orgheadline9"><span class="section-number-2">4</span> 第四部分(C24~C31)</h2>
<div class="outline-text-2" id="text-4">
<p>
如何将Lua和C混合起来使用
</p>

<p>
TODO:
</p>
</div>
</div>
</div>
<!-- DISQUS BEGIN --><div id="disqus_thread"></div><script>/***  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/var disqus_config = function () {this.page.url = 'https://dirtysalt.github.io/html/lua-prog-lang-book.html';this.page.identifier = 'lua-prog-lang-book.html';};(function() {var d = document, s = d.createElement('script');s.src = 'https://dirlt.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><!-- DISQUS END --></body>
</html>
